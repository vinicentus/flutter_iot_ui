# flutter_iot_ui
A user interface to fetch and show data generated by IoT devices, that are controlled indirectly through smart contracts. This project requires a deployed version of the smart contracts in the
[Smart Contract Backend](https://github.com/vinicentus/oracle-manager), and one or more IoT devices running [IoT-Microservice](https://github.com/vinicentus/IoT-Microservice/).  
The user inteface can be used to inspect and modify the most commonly used parameters of the smart contracts.

[geth-docker](https://github.com/vinicentus/geth-docker) can be used to start a simple ethereum test network, on which the smart contracts can be deployed.

Here is a diagram of the data flow when using storj as the backend:
![image](/docs/big%20storj%20sequence%20diagram.png)
Note that each storj access that is created by this UI is only valid for one minute, and only allows uploading the file `temp.db`.
Also note that the whole sqlite database is currently uploaded to storj. Other task types have more granular data access.

## Getting Started

This project can be run as a standalone flutter application. It is tested on Windows using desktop support for flutter, and on raspberry pi devices using [flutter-pi](https://github.com/ardera/flutter-pi). It is not tested on web or mobile devices, but could probably be modified to work on these target platforms.

This project can be run on a completely separate device from the device that is generating data, in which case the "show data from local database" switch in the settings page should be turned off.
This can also be run on the IoT device generating data, in our case a Raspberry Pi, to show data from the local database.

You can update paths in [paths.dart](lib/core/util/paths.dart) as needed.

### Prerequisites
A working [flutter](https://docs.flutter.dev/get-started/install) installation with desktop support enabled. See [Desktop support for Flutter](https://docs.flutter.dev/desktop).

ABI json file describing your smart contracts, from the truffle migrate deployment step

A Storj DCS account and an access token generated specifically for this dApp. See below
#### Generating a Storj Access
* Sign up for Storj DCS
* Create a bucket named `iot-microservice`
* Create an Access token using their web UI, only valid for the bucket `iot-microservice`
* use the Storj Uplink CLI to generate a more restricted access
    * This should only be allowed access to the one file you will acccess, currently hardcoded to be `temp.db` in the bucket bucket `iot-microservice`
    * it should have all permissions, except that the list permissions is currently not required
    * it is recommended to set an expiry date
    * example: `uplink share --access your-access-string-from-web-here sj://iot-microservice/temp.db --readonly=false --writeonly=false --disallow-lists --not-after 2023-01-01T00:00:00+02:00`
        * (replace `your-access-string-from-web-here` with the access you got from the Storj DCS Web UI)
        * This will give you a new and even more restricted access string, which will be used by the UI

### Installation steps

* _uplink_dart:_ follow the build steps of [uplink_dart](https://github.com/vinicentus/uplink_dart#instalation-steps) and place the resulting .so file in the path indicated by `libuplinkcDllPath` in [paths.dart](lib/core/util/paths.dart) (can be modified).

* _sqlite3:_
    * _linux:_ install "libsqlite3-dev", `sudo apt install libsqlite3-dev`
    * _windows:_ Go to [sqlite.org](https://www.sqlite.org/download.html), download the precompiled binaries, and put them in a directory indicated by `sqliteDllPath` in [paths.dart](lib/core/util/paths.dart) This variable can be modified to point to your preferred path.
    * See [sqlite3](https://pub.dev/packages/sqlite3#manually-providing-sqlite3-libraries) for more information

* update any other paths in [paths.dart](lib/core/util/paths.dart) to suit your needs and your machine.

* Change default ethereum keys
    * Generate a new ethereum public/private key pair using you preferred method. This will serve as the underlying key for a registered User smart contract, and will be used by all the IoT devices and User Interfaces.
    * Swap out the `public` address and `private` key fields in [settings.json](resources/settings.json)
    * The same key should be copied over to any IoT devices you wish to access, because currently, a user can only access their own devices...

* Generate new RSA keys
    * It is currently not possible to do directly, and the recommended approach is to either generate keys using any other tool for RSA key generation, or to use the script [generate_pems.py from IoT-Microservice](https://github.com/vinicentus/IoT-Microservice/blob/main/app/oracle/generate_pems.py).
    * copy over the keys to `resources/private_key.pem` and `resources/public_key.pem`.

* Paste the generated access string from the prerequisites step inside [resources/settings.json](resources/settings.json) in the `storj-access` field. 

* Copy over your generated ABI json files into `lib/core/models/contracts`. All filenames should end in `.abi.json`, example: `OracleManager.abi.json`.

* Update [settings.json](resources/settings.json) with the IP adddress of your jsonRPC geth node (the machine where you deployed [geth-docker](https://github.com/vinicentus/geth-docker))

* run this project, either in you IDE or from the terminal using `flutter run`, see the flutter docs if you want to build an executable

#### Running on IoT device (Raspberry Pi)
If you want to run this directly on the IoT device, and it is a raspberry pi running Raspberry Pi OS, then follow the installation steps from [flutter-pi](https://github.com/ardera/flutter-pi).

### Configuring contracts and devices

* Open the users page, create a user

* Open the tokens page, add tokens to your user

* Open the devices page

* Create a new device with the correct sensors, and select it

* copy over the generated `device_settings.yaml`, writing over the existing one in `IoT-Microservice/app/resources/`

* start the python service on the IoT device

* Toggle the device to be active

You are now free to view the data by selecting a data page from the menu.
